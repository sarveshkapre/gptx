name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  quality:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 npm ci

      - name: Verify self-hosted runner prerequisites
        shell: bash
        run: |
          set -euo pipefail

          if [ "${RUNNER_OS}" != "Linux" ] && [ "${RUNNER_OS}" != "macOS" ]; then
            echo "::error::This workflow requires a Linux or macOS self-hosted runner."
            echo "::error::Install prerequisites from docs/self-hosted-runner.md."
            exit 1
          fi

          if [ "${RUNNER_OS}" = "Linux" ] && ! command -v xvfb-run >/dev/null 2>&1; then
            echo "::error::xvfb-run is required for headed Playwright tests."
            echo "::error::Install xvfb on the runner host (see docs/self-hosted-runner.md)."
            exit 1
          fi

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      - name: Check build artifacts
        run: npm run check:build

      - name: Install Playwright Chromium
        run: npx playwright install chromium

      - name: E2E smoke (extension pages)
        shell: bash
        env:
          GPTX_E2E: '1'
        run: |
          set -euo pipefail
          if [ "${RUNNER_OS}" = "Linux" ]; then
            xvfb-run -a node --test test/extension-smoke.test.mjs
          else
            node --test test/extension-smoke.test.mjs
          fi
